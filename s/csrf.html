<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
  <link rel="stylesheet" href="http://granitosaur.us/scrapeground/static/css/bulma.min.css">
  <link rel="stylesheet" href="http://granitosaur.us/scrapeground/static/css/main.css">
  <script src="http://granitosaur.us/scrapeground/static/js/jquery-3.6.0.min.js"></script>
  <script src="http://granitosaur.us/scrapeground/static/js/main.js"></script>
  <script src="https://unpkg.com/htmx.org@1.7.0"></script>
  <script src="https://unpkg.com/htmx.org/dist/ext/client-side-templates.js"></script>
  <script src="https://unpkg.com/mustache@latest"></script>
  
<title>Hello</title>

</head>
<body>
  <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://scrapfly.io/">
        <img src="https://cdn.scrapfly.io/0.0.117/www/public/img/logo.png?version=0.0.117">
      </a>
      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>
  <div id="navigation" class="navbar-menu">
    <div class="navbar-start">
      <a href="http://granitosaur.us/scrapeground/" class="navbar-item">Home</a>
    <div class="navbar-item has-dropdown is-hoverable">
      <a class="navbar-link">Scenarios</a>
      <div class="navbar-dropdown">
        <a href="http://granitosaur.us/scrapeground/s/csrf.html" class="navbar-item">CSRF token</a>
      </div>
    </div>
    <div class="navbar-item has-dropdown is-hoverable">
      <a class="navbar-link">Paging</a>
      <div class="navbar-dropdown">
        <a href="http://granitosaur.us/scrapeground/paging/products-1.html" class="navbar-item">Classic</a>
        <a href="http://granitosaur.us/scrapeground/paging-infinite.html" class="navbar-item">Infinite</a>
        <a href="http://granitosaur.us/scrapeground/paging-infinite-button.html" class="navbar-item">Infinite With Button</a>
        
      </div>
    </div>
    </div>
    <div class="navbar-end">
      <div class="navbar-item">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">Learn Web Scraping</a>
          <div class="navbar-dropdown">
            <a href="https://scrapfly.io/blog/scraping-using-browsers/" class="navbar-item">Scraping Using Browsers</a>
            <a href="https://scrapfly.io/blog/how-to-scrape-without-getting-blocked-tutorial/" class="navbar-item">Web Scraper Blocking</a>
            <a href="https://scrapfly.io/blog/parsing-html-with-xpath/" class="navbar-item">Parsing HTML with XPATH</a>
            <a href="https://scrapfly.io/blog/parsing-html-with-css/" class="navbar-item">Parsing HTML with CSS</a>
            <hr class="navbar-divider">
            <a href="https://scrapfly.io/blog/web-scraping-with-python/" class="navbar-item">Python</a>
            <a href="https://scrapfly.io/blog/web-scraping-with-selenium-and-python/" class="navbar-item">Python+Selenium</a>
            <hr class="navbar-divider">
            <a href="https://scrapfly.io/blog/web-scraping-with-nodejs/" class="navbar-item">NodeJS</a>
            <a href="https://scrapfly.io/blog/web-scraping-with-puppeteer-and-nodejs/" class="navbar-item">NodeJS+Puppteer</a>
          </div>
        </div>
        <div class="buttons">
          <a href="https://scrapfly.io/" class="button is-primary"> <strong>Try ScrapFly</strong> </a>
        </div>
      </div>
    </div>
  </div>
</nav>
  <div class="container content">
  
<div class="box">
<h1>CSRF Token Scenario</h1>
<p>This scenario illustrates example when csrf token is used to confirm that background requests (XHR) 
    are coming from the same client.</p>
<p>To illustrate this let's take a look at this example csrf-enabled search system:</p>
<div class="post-form box">
    <h4>Example Search Page</h4>
    <input class="input" placeholder="enter search query" name="search">
    <button class="button" hx-post="/s/csrf/protected" hx-target="#results" hx-headers='{"x-csrf-token": "1234abcd"}'>Search</button>
    <h4>results:</h4>
    <pre id="results"></pre>
</div>
<p>If we click "search" and take a look at the <b>Devtools Network</b> tab of our devtools we can see that this request sent an <code>x-csrf-token</code> header:</p>
<img src="/static/media/csrf-inspector.webp">
<p>When scraping this hidden API without csrf token we'd receive a 403 response:</p>
<details><summary>In ScrapFly SDK</summary>
</pre>
</details>
<h2>Where to find CSRF tokens?</h2>
<p>Csrf tokens are usually hidden in any publically reachable HTML page. Like <code>input</code> node:</p>
<pre>&lt;input type=&quot;hidden&quot; name=&quot;csrf-token&quot; value=&quot;1234abcd&quot;/&gt;</pre>
<p>take a look at the page source of this page to find this token below ðŸ‘‡</p>
<input type="hidden" name="csrf-token" value="" />
<p>To replicate this behavior in our scraper we need to:</p>
<ol>
    <li>Retrieve HTML page with hidden token (this page)</li>
    <li>Parse the html and find the token</li>
    <li>Include token in our hidden API requests</li>
</ol>
<p>We can achieve this in few lines of Python code:</p>
<details><summary>In ScrapFly SDK</summary>

<pre>
from scrapfly import ScrapflyClient, ScrapeConfig

client = ScrapflyClient(key="your key")
# get HTML page and extract csrf token:
result_html = client.scrape(ScrapeConfig(
    url="http://localhost:8000/csrf",
))
token = result_html.selector.css('input[name=csrf-token]::attr(value)').get()
# get API response using found token:
result_api = client.scrape(ScrapeConfig(
    url="http://localhost:8000/csrf/protected",
    headers={"x-csrf-token": "token"},
))

</pre>
</details>
<details><summary>In Python <code>requests</code></summary>

<pre>
import httpx
from parsel import Selector

response = httpx.get("http://localhost:8000/csrf")
selector = Selector(text=response.text)
token = selector.css('input[name=csrf-token]::attr(value)').get()
api_response = httpx.get(
    "http://localhost:8000/csrf/protected", 
    headers={"x-csrf-token": token},
)
</pre>
</details>
</div>

  </div>
</body>
</html>